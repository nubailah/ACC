<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ACCOUNTING EXAM FOR CFAB</title>
<style>
body { font-family: Arial; max-width:800px; margin:auto; padding:20px; }
h1 { text-align:center; }
#pdfLink { text-align:center; margin-bottom:20px; }
.student-info { display:flex; gap:10px; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
#questions { display:flex; flex-direction:column; gap:10px; margin-bottom:20px; }
.question-row { display:flex; justify-content:space-between; background:#f9f9f9; padding:10px; border-radius:5px; }
.question-row p { margin:0; width:60%; }
.question-row input { width:35%; padding:5px; }
button { padding:10px 20px; font-size:16px; cursor:pointer; }
button:disabled { opacity:0.6; cursor:not-allowed; }
#result { text-align:center; font-weight:bold; margin-top:15px; color:red; }
</style>
</head>
<body>
<h1>ACCOUNTING EXAM FOR CFAB</h1>
<div id="pdfLink">Loading PDF link...</div>

<div class="student-info">
<input type="text" id="studentName" placeholder="Your Name">
<input type="text" id="studentID" placeholder="Student ID">
<button id="loadQuestionsBtn" onclick="loadQuestions()" disabled>Load Questions</button>
<button id="submitBtn" onclick="submitAnswers()" disabled>Submit Answers</button>
</div>

<div id="questions"></div>
<p id="result"></p>

<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbz1E9b-QMxQ35q0z71oX8IUWB1Tlrdb7J9lAxFmSgNWPZzsrtq8ftSN1hFTORGPV5gHNg/exec";
let questionData=[];

// -----------------------------
// Check submission status
// -----------------------------
async function checkSubmission(id){
  if(!id) return false;
  try{
    const res = await fetch(`${WEBAPP_URL}?action=checkSubmissionStatus&id=${encodeURIComponent(id)}`);
    const data = await res.json();
    return data.submitted;
  }catch(err){ console.error(err); return false; }
}

// -----------------------------
// Check if exam is active
// -----------------------------
async function isExamActive(){
  try{
    const res = await fetch(`${WEBAPP_URL}?action=getExamTime`);
    const data = await res.json();
    if(!data.start || !data.end) return false;
    const now = new Date().getTime();
    return now >= data.start && now <= data.end;
  } catch(err){ console.error(err); return false; }
}

// -----------------------------
// Load PDF link
// -----------------------------
async function loadPdfLink(){
  try{
    const res = await fetch(`${WEBAPP_URL}?action=getPdfLink`);
    const data = await res.json();
    const pdfContainer = document.getElementById("pdfLink");
    if(data.link) pdfContainer.innerHTML = `<a href="${data.link}" target="_blank">Click here to open Question Exam</a>`;
    else pdfContainer.innerText = "No PDF link available.";
  }catch(err){document.getElementById("pdfLink").innerText="Failed to load PDF link: "+err;}
}

// -----------------------------
// Load questions
// -----------------------------
async function loadQuestions(){
  const name = document.getElementById("studentName").value.trim();
  const id = document.getElementById("studentID").value.trim();
  const msg = document.getElementById("result");
  msg.innerText="";

  if(!name || !id){ alert("Enter name & ID"); return; }

  const active = await isExamActive();
  if(!active){ msg.innerText="Exam not active now."; return; }

  const alreadySubmitted = await checkSubmission(id);
  if(alreadySubmitted){ msg.innerText = "You have already submitted."; disableAllInputs(); return; }

  try{
    const res = await fetch(`${WEBAPP_URL}?action=getQuestions`);
    questionData = await res.json();
    if(questionData.length===0){ msg.innerText="Exam not active now."; return; }

    const container = document.getElementById("questions");
    container.innerHTML = "";
    questionData.forEach((q,i)=>{
      const div = document.createElement("div");
      div.className = "question-row";
      div.innerHTML = `<p>${i+1}. ${q.question} (Max: ${q.maxMark})</p>
                       <input type="text" id="ans${i}" placeholder="Your answer">`;
      container.appendChild(div);
    });
    document.getElementById("submitBtn").disabled=false;
  }catch(err){ msg.innerText="Failed to load questions: "+err; }
}

// -----------------------------
// Submit answers
// -----------------------------
async function submitAnswers(){
  const name = document.getElementById("studentName").value.trim();
  const id = document.getElementById("studentID").value.trim();
  const answers = questionData.map((_,i)=>document.getElementById(`ans${i}`).value);
  const msg = document.getElementById("result");

  const url = `${WEBAPP_URL}?action=checkAnswersAndSave&name=${encodeURIComponent(name)}&id=${encodeURIComponent(id)}&answers=${encodeURIComponent(JSON.stringify(answers))}`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    alert(data.message);
    if(data.status==="success"){ msg.innerText="Submission successful!"; disableAllInputs(); }
    else msg.innerText = data.message;
  } catch(err){ alert("Error submitting answers: "+err); }
}

// -----------------------------
// Disable all inputs
// -----------------------------
function disableAllInputs(){
  document.getElementById("studentName").disabled=true;
  document.getElementById("studentID").disabled=true;
  document.getElementById("loadQuestionsBtn").disabled=true;
  document.getElementById("submitBtn").disabled=true;
  questionData.forEach((_,i)=>{
    const input = document.getElementById(`ans${i}`);
    if(input) input.disabled = true;
  });
}

// -----------------------------
// Auto enable / disable Load Questions
// -----------------------------
function autoCheckLoad(){
  const loadBtn = document.getElementById("loadQuestionsBtn");
  const nameInput = document.getElementById("studentName");
  const idInput = document.getElementById("studentID");
  const resultMsg = document.getElementById("result");

  async function checkEnable(){
    const name = nameInput.value.trim();
    const id = idInput.value.trim();
    if(!id) { loadBtn.disabled=true; resultMsg.innerText=""; return; }

    const active = await isExamActive();
    const submitted = await checkSubmission(id);
    if(!active){ loadBtn.disabled=true; resultMsg.innerText="Exam not active now."; return; }
    if(submitted){ loadBtn.disabled=true; resultMsg.innerText="You have already submitted."; return; }
    loadBtn.disabled=false; resultMsg.innerText="";
  }

  nameInput.addEventListener("input", checkEnable);
  idInput.addEventListener("input", checkEnable);
  checkEnable(); // initial check
}

// -----------------------------
// On load
// -----------------------------
window.onload = () => {
  loadPdfLink();
  autoCheckLoad();
};
</script>
</body>
</html>
