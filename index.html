<!DOCTYPE html>
<html>
<head>
  <title>Exam System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 8px; }
    iframe { border:1px solid #ccc; border-radius:8px; }
  </style>
</head>
<body>
  <h2>Exam System</h2>

  <label>Student Name:</label>
  <input type="text" id="studentName"><br>

  <label>Student ID:</label>
  <input type="text" id="studentID"><br>

  <button onclick="loadQuestions()">Load Questions</button>
  <div id="questions"></div>

  <button onclick="submitAnswers()">Submit Answers</button>
  <p id="result"></p>

  <h3>Exam Paper</h3>
  <div id="pdfContainer"></div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbynywD9M-OLdVubQA7CfGV66pIaz0LIFFBxMNNVcVX1_10TGdcHLpMUV5QKsFbTzCjKDA/exec"; // <-- letak link deploy Apps Script

    // Load Questions
    async function loadQuestions(){
      try {
        const res = await fetch(`${WEBAPP_URL}?action=getQuestions`);
        const data = await res.json();
        const container = document.getElementById("questions");
        container.innerHTML = "";
        if(data.length === 0){
          container.innerHTML = "<p>No questions found.</p>";
          return;
        }
        data.forEach((q, i) => {
          const div = document.createElement("div");
          div.innerHTML = `<p>${i+1}. ${q.text} (Max: ${q.marks})</p>
                           <input type="text" id="ans${i}" placeholder="Your answer">`;
          container.appendChild(div);
        });
      } catch(err){
        console.error("Error loading questions:", err);
        alert("Failed to load questions.");
      }
    }

    // Submit Answers
    async function submitAnswers(){
      const name = document.getElementById("studentName").value.trim();
      const id = document.getElementById("studentID").value.trim();
      const answers = Array.from(document.querySelectorAll("#questions input")).map(inp => inp.value);

      try {
        const res = await fetch(`${WEBAPP_URL}?action=checkAnswersAndSave&name=${encodeURIComponent(name)}&id=${encodeURIComponent(id)}&answers=${encodeURIComponent(JSON.stringify(answers))}`);
        const data = await res.json();
        document.getElementById("result").innerText = `You scored: ${data.total} marks.`;

        // disable inputs after submit
        document.querySelectorAll("#questions input").forEach(inp => inp.disabled = true);
      } catch(err){
        console.error("Error submitting answers:", err);
        alert("Failed to submit answers.");
      }
    }

    // Load PDF from Apps Script
    async function loadPdfLink(){
      try {
        const res = await fetch(`${WEBAPP_URL}?action=getPdfLink`);
        const data = await res.json();
        const pdfContainer = document.getElementById("pdfContainer");

        if(data.link){
          pdfContainer.innerHTML = `
            <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(data.link)}&embedded=true" 
                    width="100%" height="600px"></iframe>`;
        } else {
          pdfContainer.innerHTML = "<p>No PDF link found.</p>";
        }
      } catch(err){
        console.error("Error loading PDF:", err);
        alert("Failed to load PDF.");
      }
    }

    // Auto-load PDF when page open
    loadPdfLink();
  </script>
</body>
</html>
