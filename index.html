<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ACCOUNTING EXAM FOR CFAB</title>
<style>
body { font-family: Arial; max-width:800px; margin:auto; padding:20px; }
h1 { text-align:center; }
#pdfLink { text-align:center; margin-bottom:20px; }
.student-info { display:flex; gap:10px; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
#questions { display:flex; flex-direction:column; gap:10px; margin-bottom:20px; }
.question-row { display:flex; justify-content:space-between; background:#f9f9f9; padding:10px; border-radius:5px; }
.question-row p { margin:0; width:60%; }
.question-row input { width:35%; padding:5px; }
button { padding:10px 20px; font-size:16px; cursor:pointer; }
button:disabled { opacity:0.6; cursor:not-allowed; }
#result { text-align:center; font-weight:bold; margin-top:15px; }
</style>
</head>
<body>
<h1>ACCOUNTING EXAM FOR CFAB</h1>
<div id="pdfLink">Loading qUETION EXAM</div>

<div class="student-info">
<input type="text" id="studentName" placeholder="Your Name">
<input type="text" id="studentID" placeholder="Student ID">
<button id="loadQuestionsBtn" onclick="loadQuestions()">Load Questions</button>
<button id="submitBtn" onclick="submitAnswers()" disabled>Submit Answers</button>
</div>

<div id="questions"></div>
<p id="result"></p>

<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbzmENmihQn1sphS9dUHfEN_1isB7Coo69r7l4xqol_ECWTFAkMG4LwMRIXgw9cos0YJ2A/exec";
let questionData=[];

// load PDF link
async function loadPdfLink(){
  try{
    const res = await fetch(`${WEBAPP_URL}?action=getPdfLink`);
    const data = await res.json();
    const pdfContainer = document.getElementById("pdfLink");
    if(data.link){
      pdfContainer.innerHTML = `<a href="${data.link}" target="_blank">Click here to open Question Exam</a>`;
    } else {
      pdfContainer.innerText = data.message || "No PDF link available.";
      document.getElementById("loadQuestionsBtn").disabled=true;
    }
  } catch(err){ document.getElementById("pdfLink").innerText="Failed to load PDF link: "+err; }
}

// periksa sama ada ID sudah submit
async function checkSubmission(id){
  try{
    const res = await fetch(`${WEBAPP_URL}?action=checkSubmissionStatus&id=${encodeURIComponent(id)}`);
    const data = await res.json();
    return data===true;
  }catch(err){ return false; }
}

// load questions
async function loadQuestions(){
  const name = document.getElementById("studentName").value.trim();
  const id   = document.getElementById("studentID").value.trim();
  const msg  = document.getElementById("result");
  msg.innerText="";

  if(!name || !id){ alert("Enter name & ID"); return; }

  const alreadySubmitted = await checkSubmission(id);
  if(alreadySubmitted){ msg.innerText="You have already submitted."; disableAllInputs(); return; }

  try{
    const res = await fetch(`${WEBAPP_URL}?action=getQuestions`);
    const data = await res.json();
    if(!data.questions || data.questions.length===0){ msg.innerText=data.message||"Exam not open."; return; }

    questionData = data.questions;
    const container = document.getElementById("questions");
    container.innerHTML="";
    questionData.forEach((q,i)=>{
      const div = document.createElement("div");
      div.className="question-row";
      div.innerHTML = `<p>${i+1}. ${q.question} (Max: ${q.maxMark})</p>
                       <input type="text" id="ans${i}" placeholder="Your answer">`;
      container.appendChild(div);
    });
    document.getElementById("submitBtn").disabled=false;
  }catch(err){ msg.innerText="Failed to load questions: "+err; }
}

// submit answers
async function submitAnswers(){
  const name = document.getElementById("studentName").value.trim();
  const id   = document.getElementById("studentID").value.trim();
  const answers = questionData.map((_,i)=>document.getElementById(`ans${i}`).value);

  const url = `${WEBAPP_URL}?action=checkAnswersAndSave&name=${encodeURIComponent(name)}&id=${encodeURIComponent(id)}&answers=${encodeURIComponent(JSON.stringify(answers))}`;

  try{
    const res = await fetch(url);
    const data = await res.json();
    alert(data.message);
    disableAllInputs();
  }catch(err){ alert("Error submitting answers: "+err); }
}

// disable semua input
function disableAllInputs(){
  document.getElementById("studentName").disabled=true;
  document.getElementById("studentID").disabled=true;
  questionData.forEach((_,i)=>document.getElementById(`ans${i}`)?.setAttribute("disabled",true));
  document.getElementById("submitBtn").disabled=true;
}

// load PDF on page load
window.onload = loadPdfLink;
</script>

</body>
</html>
